name: Deploy Staging (Cloud Run)

on:
  workflow_dispatch:
  push:
    branches:
      - main  # Change if your deploy branch differs

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION }}
  DOMAIN: ${{ vars.STAGING_DOMAIN }}
  REPO_NAME: lifegeek
  IMAGE_TAG: ${{ github.sha }}

jobs:
  deploy:
    name: Build and Deploy (Staging)
    runs-on: ubuntu-latest
    if: ${{ github.ref_name == (vars.DEPLOY_BRANCH || 'main') || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (Workload Identity Federation)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          install_components: 'beta'

      - name: Verify required env
        run: |
          set -euo pipefail
          : "${PROJECT_ID:?missing}"; : "${REGION:?missing}"; : "${DOMAIN:?missing}"
          echo "Project: $PROJECT_ID"
          echo "Region:  $REGION"
          echo "Domain:  $DOMAIN"

      - name: Ensure Artifact Registry exists (idempotent)
        run: |
          set -euo pipefail
          if ! gcloud artifacts repositories list --location="${REGION}" --format="value(name)" | grep -q "/${REPO_NAME}$"; then
            gcloud artifacts repositories create "${REPO_NAME}" \
              --repository-format=docker \
              --location="${REGION}" \
              --description="LifeGeek images"
          else
            echo "Artifact Registry ${REPO_NAME} already exists in ${REGION}"
          fi

      # ---------- Build images with Cloud Build ----------
      - name: Build Search Service
        run: |
          gcloud builds submit backend/services/search-service \
            --tag "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/search-service:${IMAGE_TAG}"

      - name: Build Weather Service
        run: |
          gcloud builds submit backend/services/weather-service \
            --tag "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/weather-service:${IMAGE_TAG}"

      - name: Build Wardrobe Service
        run: |
          gcloud builds submit backend/services/wardrobe-service \
            --tag "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/wardrobe-service:${IMAGE_TAG}"

      - name: Build Fashion Service
        run: |
          gcloud builds submit backend/services/fashion-service \
            --tag "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/fashion-service:${IMAGE_TAG}"

      - name: Build Frontend
        run: |
          gcloud builds submit frontend \
            --tag "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/frontend:${IMAGE_TAG}"

      # ---------- Deploy backends ----------
      - name: Deploy Search Service
        run: |
          gcloud run deploy search-service \
            --region "${REGION}" \
            --image "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/search-service:${IMAGE_TAG}" \
            --allow-unauthenticated \
            --set-secrets=EBAY_CLIENT_ID=EBAY_CLIENT_ID:latest,EBAY_CLIENT_SECRET=EBAY_CLIENT_SECRET:latest

      - name: Deploy Weather Service
        run: |
          gcloud run deploy weather-service \
            --region "${REGION}" \
            --image "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/weather-service:${IMAGE_TAG}" \
            --allow-unauthenticated \
            --set-secrets=OPENWEATHER_API_KEY=OPENWEATHER_API_KEY:latest

      - name: Deploy Wardrobe Service
        run: |
          gcloud run deploy wardrobe-service \
            --region "${REGION}" \
            --image "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/wardrobe-service:${IMAGE_TAG}" \
            --allow-unauthenticated \
            --set-secrets=CLAUDE_API_KEY=CLAUDE_API_KEY:latest

      - id: backend_urls
        name: Read Backend URLs
        run: |
          set -euo pipefail
          SEARCH_URL="$(gcloud run services describe search-service --region "${REGION}" --format='value(status.url)')"
          WEATHER_URL="$(gcloud run services describe weather-service --region "${REGION}" --format='value(status.url)')"
          WARDROBE_URL="$(gcloud run services describe wardrobe-service --region "${REGION}" --format='value(status.url)')"
          echo "search_url=${SEARCH_URL}"   >> "$GITHUB_OUTPUT"
          echo "weather_url=${WEATHER_URL}" >> "$GITHUB_OUTPUT"
          echo "wardrobe_url=${WARDROBE_URL}" >> "$GITHUB_OUTPUT"
          echo "Search:   ${SEARCH_URL}"
          echo "Weather:  ${WEATHER_URL}"
          echo "Wardrobe: ${WARDROBE_URL}"

      - name: Deploy Fashion Service (wiring backend URLs)
        run: |
          gcloud run deploy fashion-service \
            --region "${REGION}" \
            --image "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/fashion-service:${IMAGE_TAG}" \
            --allow-unauthenticated \
            --set-secrets=CLAUDE_API_KEY=CLAUDE_API_KEY:latest \
            --set-env-vars=SEARCH_SERVICE_URL=${{ steps.backend_urls.outputs.search_url }},WEATHER_SERVICE_URL=${{ steps.backend_urls.outputs.weather_url }},WARDROBE_SERVICE_URL=${{ steps.backend_urls.outputs.wardrobe_url }}

      - id: fashion_url
        name: Read Fashion URL
        run: |
          FASHION_URL="$(gcloud run services describe fashion-service --region "${REGION}" --format='value(status.url)')"
          echo "fashion_url=${FASHION_URL}" >> "$GITHUB_OUTPUT"
          echo "Fashion: ${FASHION_URL}"

      # ---------- Deploy frontend ----------
      - name: Deploy Frontend (env wiring + secrets)
        run: |
          gcloud run deploy frontend \
            --region "${REGION}" \
            --image "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/frontend:${IMAGE_TAG}" \
            --allow-unauthenticated \
            --set-env-vars=FASHION_SERVICE_URL=${{ steps.fashion_url.outputs.fashion_url }},SEARCH_SERVICE_URL=${{ steps.backend_urls.outputs.search_url }},WEATHER_SERVICE_URL=${{ steps.backend_urls.outputs.weather_url }},WARDROBE_SERVICE_URL=${{ steps.backend_urls.outputs.wardrobe_url }},NEXT_PUBLIC_SITE_URL=https://${DOMAIN} \
            --set-secrets=CLAUDE_API_KEY=CLAUDE_API_KEY:latest,EBAY_CLIENT_ID=EBAY_CLIENT_ID:latest,EBAY_CLIENT_SECRET=EBAY_CLIENT_SECRET:latest

      - id: frontend_url
        name: Read Frontend URL
        run: |
          FRONTEND_URL="$(gcloud run services describe frontend --region "${REGION}" --format='value(status.url)')"
          echo "frontend_url=${FRONTEND_URL}" >> "$GITHUB_OUTPUT"
          echo "Frontend (Cloud Run URL): ${FRONTEND_URL}"

      - name: Summary
        run: |
          echo "----------------------------------------------------"
          echo "Cloud Run URLs:"
          echo "  Search:   ${{ steps.backend_urls.outputs.search_url }}"
          echo "  Weather:  ${{ steps.backend_urls.outputs.weather_url }}"
          echo "  Wardrobe: ${{ steps.backend_urls.outputs.wardrobe_url }}"
          echo "  Fashion:  ${{ steps.fashion_url.outputs.fashion_url }}"
          echo "  Frontend (service URL): ${{ steps.frontend_url.outputs.frontend_url }}"
          echo "Front door (IAP/LB): https://${DOMAIN}"
      ci: make Artifact Registry step idempotent

          echo "----------------------------------------------------"
